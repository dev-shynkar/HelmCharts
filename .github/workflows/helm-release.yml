name: Publish Helm Charts

on:
  push:
    branches: [ main, master ]
    paths: 
      - 'charts/**'
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Helm
        uses: azure/setup-helm@v3
        with:
          version: '3.13.0'

      - name: Create packages directory
        run: mkdir -p packages

      - name: Package charts
        run: |
          echo "ðŸ“¦ Packaging charts from charts/ directory..."
          for chart in charts/*/; do
            if [ -f "$chart/Chart.yaml" ]; then
              chart_name=$(basename "$chart")
              echo "Packaging $chart_name..."
              helm package "$chart" --destination packages/
            fi
          done

      - name: Generate repository index
        run: |
          echo "ðŸ“‹ Generating repository index..."
          helm repo index packages/ --url https://dev-shynkar.github.io/HelmCharts/
          
          echo "ðŸ“ Creating README..."
          cat > packages/README.md << 'EOF'
          # Dev-Shynkar Helm Charts Repository

          ## ðŸš€ Ð”Ð¾Ð´Ð°Ð²Ð°Ð½Ð½Ñ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ñ–ÑŽ

          ```bash
          helm repo add dev-shynkar https://dev-shynkar.github.io/HelmCharts/
          helm repo update
          ```

          ## ðŸ” ÐŸÐ¾ÑˆÑƒÐº Ñ‡Ð°Ñ€Ñ‚Ñ–Ð²

          ```bash
          helm search repo dev-shynkar
          ```

          ## ðŸ“¦ Ð’ÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð½Ñ Duplicati

          ```bash
          # Ð‘Ð°Ð·Ð¾Ð²Ðµ Ð²ÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð½Ñ
          helm install my-duplicati dev-shynkar/duplicati

          # Ð— Ð½Ð°Ð»Ð°ÑˆÑ‚ÑƒÐ²Ð°Ð½Ð½ÑÐ¼Ð¸
          helm install my-duplicati dev-shynkar/duplicati \
            --set service.type=NodePort \
            --set persistence.enabled=true
          ```

          ## ðŸ”„ ÐžÐ½Ð¾Ð²Ð»ÐµÐ½Ð½Ñ

          ```bash
          helm upgrade my-duplicati dev-shynkar/duplicati
          ```

          ---
          *ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡Ð½Ð¾ Ð¾Ð½Ð¾Ð²Ð»ÑŽÑ”Ñ‚ÑŒÑÑ Ñ‡ÐµÑ€ÐµÐ· GitHub Actions*
          EOF

      - name: List packaged charts
        run: |
          echo "âœ… Packaged charts:"
          ls -la packages/
          echo ""
          echo "ðŸ“‹ Index content:"
          cat packages/index.yaml

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./packages
          commit_message: "ðŸ“¦ Update Helm repository [skip ci]"